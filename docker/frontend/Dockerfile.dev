FROM node:20-alpine AS base

# Instalar dependencias del sistema
RUN apk add --no-cache bash curl git

# Configurar pnpm
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
RUN corepack enable

WORKDIR /app

# Crear usuario no-root
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 nextjs

# ============================================
# STAGE: Installer
# ============================================
FROM base AS installer

# Copiar archivos de configuración del workspace
COPY pnpm-lock.yaml pnpm-workspace.yaml ./
COPY package.json ./
COPY apps/backend/package.json ./apps/backend/
COPY apps/frontend/package.json ./apps/frontend/

# Instalar dependencias SIN ejecutar scripts
RUN pnpm install --frozen-lockfile --ignore-scripts

# Copiar código fuente
COPY . .

# ============================================
# STAGE: Development
# ============================================
FROM base AS development

# Copiar node_modules y código desde installer
COPY --from=installer --chown=nextjs:nodejs /app .

# Cambiar al usuario no-root
USER nextjs

# Configurar variables de entorno para desarrollo
ENV NODE_ENV=development
ENV NEXT_TELEMETRY_DISABLED=1

# Exponer puerto
EXPOSE 3000

# Comando para desarrollo
CMD ["pnpm", "--filter", "frontend", "run", "dev"] 